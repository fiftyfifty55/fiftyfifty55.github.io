<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å•†å“è©³æƒ… - Meow5</title>

  <style>
    :root{
      --bg:#f6f1ee;
      --panel:#efe4e0;
      --ink:#151515;
      --muted:#6e6e6e;
      --line:rgba(0,0,0,.12);
      --chip:#e6d7d1;
      --btn:#d7bfb7;
      --btnText:#1a1a1a;
      --star:#f3c44b;
      --accent:#b0714d;
      --card:#ffffff;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,"Noto Sans TC";
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{ max-width:1080px; margin:0 auto; padding:28px 18px 60px; }

    .top{ display:grid; grid-template-columns: 1.05fr 1fr; gap:40px; align-items:start; }

    /* gallery */
    .gallery{ position:relative; }
    .imgBox{
      width:100%;
      aspect-ratio:1/1;
      background:var(--panel);
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.06);
    }
    .imgBox img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .dots{ display:flex; gap:10px; justify-content:center; padding:14px 0 0; }
    .dot{ width:8px; height:8px; border-radius:50%; background:rgba(0,0,0,.18); cursor:pointer; }
    .dot.active{ background:rgba(0,0,0,.55); }

    /* info */
    .info h1{ margin:0; font-size:36px; font-weight:900; letter-spacing:1px; }
    .price{ margin-top:6px; font-size:28px; font-weight:900; color:var(--accent); }

    .meta{
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:12px;
      color:var(--muted);
      font-size:13px;
      flex-wrap:wrap;
    }
    .rating{ display:flex; align-items:center; gap:6px; }
    .stars{ display:inline-flex; gap:2px; transform:translateY(1px); }
    .star{ width:16px; height:16px; display:inline-block; fill:currentColor; color:var(--star); }
    .meta .divider{ width:1px; height:14px; background:var(--line); }

    .rule{ margin:16px 0; height:1px; background:var(--line); }

    /* tabs + options */
    .specHead{ display:flex; align-items:center; gap:10px; margin-top:10px; }
    .specHead .label{ font-size:14px; font-weight:900; }
    .tabs{ display:flex; gap:8px; }
    .tab{
      border:1px solid var(--line);
      background:transparent;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      color:#333;
    }
    .tab.active{ background:var(--chip); border-color:transparent; font-weight:800; }

    .options{ margin-top:12px; min-height:58px; position:relative; }
    .optRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .sizeBtn{
      width:34px; height:34px; border-radius:50%;
      border:1px solid rgba(0,0,0,.25);
      background:transparent;
      cursor:pointer;
      font-weight:900;
    }
    .sizeBtn.active{
      background:#fff;
      border-color:rgba(0,0,0,.55);
      box-shadow:0 1px 0 rgba(0,0,0,.05);
    }
    .colorDot{
      width:28px; height:28px; border-radius:50%;
      border:1px solid rgba(0,0,0,.12);
      cursor:pointer;
      position:relative;
    }
    .colorDot.active{ outline:2px solid rgba(0,0,0,.55); outline-offset:2px; }

    .bubbleRight{
      margin-top:8px;
      display:inline-block;
      background:#cdb4aa;
      padding:8px 10px;
      border-radius:6px;
      font-size:12px;
      position:relative;
      color:#1a1a1a;
    }
    .bubbleRight::after{
      content:"";
      position:absolute;
      left:14px;
      top:-8px;
      border-width:8px;
      border-style:solid;
      border-color:transparent transparent #cdb4aa transparent;
    }

    /* CTA row */
    .ctaRow{ margin-top:16px; display:flex; gap:10px; align-items:center; }
    .addBtn{
      flex:1; height:40px; border:none; border-radius:10px;
      background:var(--btn); color:var(--btnText);
      font-weight:900; cursor:pointer;
    }
    .addBtn:hover{ filter:brightness(.97); }
    .pawBtn{
      width:40px; height:40px; border:none; border-radius:10px;
      background:var(--btn); cursor:pointer; font-size:18px;
      display:flex; align-items:center; justify-content:center;
    }

    /* sections below */
    .section{ margin-top:28px; }
    .section h2{ margin:0 0 10px; font-size:14px; letter-spacing:1px; font-weight:900; }
    .block{
      background:var(--panel);
      border-radius:12px;
      padding:22px;
      border:1px solid rgba(0,0,0,.05);
      color:rgba(0,0,0,.72);
      line-height:1.8;
    }

    /* reviews */
    .reviewHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .reviewScore{ display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px; }

    .reviewForm{
      background:var(--card);
      border:1px solid rgba(0,0,0,.08);
      border-radius:14px;
      padding:14px;
      display:grid;
      gap:10px;
    }
    .reviewForm.disabled{
      opacity:.6;
      pointer-events:none;
    }

    .starsPick{
      display:flex;
      gap:6px;
      align-items:center;
      user-select:none;
    }
    .pickStar{
      width:22px;
      height:22px;
      cursor:pointer;
      fill:currentColor;
      color:rgba(0,0,0,.18);
    }
    .pickStar.on{ color:var(--star); }

    textarea{
      width:100%;
      min-height:90px;
      resize:vertical;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.12);
      padding:10px 12px;
      font-family:inherit;
      outline:none;
    }
    .submitRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .btn{
      border:none;
      border-radius:10px;
      background:var(--accent);
      color:white;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
    }
    .btn:hover{ filter:brightness(.97); }

    .hintText{
      color:#777;
      font-size:12px;
      line-height:1.5;
    }

    .reviewsList{
      margin-top:12px;
      display:grid;
      gap:10px;
    }
    .reviewItem{
      background:var(--card);
      border:1px solid rgba(0,0,0,.08);
      border-radius:14px;
      padding:12px 14px;
    }
    .reviewTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:6px;
    }
    .reviewUser{ font-weight:900; }
    .reviewTime{ font-size:12px; color:#888; }
    .reviewText{ color:#444; line-height:1.7; white-space:pre-wrap; }

    /* also bought */
    .alsoTitle{
      margin-top:36px;
      display:flex;
      align-items:center;
      gap:14px;
      justify-content:center;
      color:#111;
      font-weight:900;
      letter-spacing:2px;
    }
    .line{ flex:1; height:2px; background:rgba(0,0,0,.35); max-width:220px; }

    .cards{
      margin-top:18px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:16px;
    }
    .p-card{
      display:block;
      text-decoration:none;
      color:inherit;
      background:var(--card);
      border:1px solid rgba(0,0,0,.08);
      border-radius:14px;
      overflow:hidden;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .p-card:hover{
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
    }
    .p-img{
      aspect-ratio:4/3;
      background:var(--panel);
      background-size:cover;
      background-position:center;
    }
    .p-body{ padding:10px 10px 12px; }
    .p-name{
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin-bottom:6px;
    }
    .p-price{ font-weight:900; color:var(--accent); font-size:13px; }

    @media (max-width:860px){
      .top{ grid-template-columns:1fr; }
      .cards{ grid-template-columns:repeat(2,1fr); }
    }

    /* =========================
   è©•è«–é€å‡ºæŒ‰éˆ•ï¼ˆMeow5 é¢¨æ ¼ï¼‰
========================= */
#submitReviewBtn{
  appearance: none;
  border: none;
  border-radius: 999px;
  padding: 10px 22px;
  background: linear-gradient(135deg, #d7bfb7, #cdb4aa);
  color: #1a1a1a;
  font-weight: 900;
  letter-spacing: 1px;
  cursor: pointer;
  transition: 
    transform .15s ease,
    box-shadow .15s ease,
    filter .15s ease;
  box-shadow: 0 6px 14px rgba(0,0,0,.12);
}

/* hoverï¼šå¾®å¾®æµ®èµ· */
#submitReviewBtn:hover{
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(0,0,0,.16);
  filter: brightness(1.02);
}

/* é»æ“Šå›é¥‹ */
#submitReviewBtn:active{
  transform: translateY(0);
  box-shadow: 0 4px 10px rgba(0,0,0,.14);
}

/* è¢« disabled æ™‚ï¼ˆå¦‚æœä½ ä¹‹å¾Œè¦ç”¨ï¼‰ */
#submitReviewBtn:disabled{
  opacity: .5;
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
}

  </style>
</head>

<body>
  <div class="wrap">
    <section class="top">

      <!-- left: gallery -->
      <div class="gallery">
        <div class="imgBox">
          <img id="mainImg" src="" alt="å•†å“åœ–ç‰‡" />
        </div>
        <div class="dots" id="dotsArea"></div>
      </div>

      <!-- right: info -->
      <div class="info">
        <h1 id="prodName">å•†å“å</h1>
        <div class="price" id="prodPrice">$XXX</div>

        <div class="meta" id="metaArea"></div>

        <div class="rule"></div>

        <div class="specHead">
          <div class="label" id="specLabel">è¦æ ¼</div>
          <div class="tabs" id="tabsArea"></div>
        </div>

        <div class="options" id="optionsArea"></div>

        <div class="ctaRow">
          <button class="addBtn" id="addToCartBtn">åŠ å…¥è³¼ç‰©è»Š</button>
          <button class="pawBtn" id="pawBtn" aria-label="æ”¶è—æˆ–åŠ å…¥æœ€æ„›">ğŸ¾</button>
        </div>
      </div>
    </section>

    <!-- ä¸‹æ–¹å€å¡Š -->
    <section class="section">
      <h2>å•†å“ä»‹ç´¹</h2>
      <div class="block" id="descBlock">æš«ç„¡ä»‹ç´¹</div>
    </section>

    <section class="section">
      <h2>è©³ç´°è¦æ ¼</h2>
      <div class="block" id="specBlock">æš«ç„¡è¦æ ¼</div>
    </section>

    <section class="section">
      <h2>ç©æ³•/ç”¨æ³•</h2>
      <div class="block" id="howBlock">æš«ç„¡èªªæ˜</div>
    </section>

    <!-- è©•è«– -->
    <section class="section" id="reviewSection">
  <div class="reviewHead">
    <h2 style="margin:0;">è©•è«–</h2>
    <div class="reviewScore" id="reviewScoreArea"></div>
  </div>

  <!-- è©•è«–è¡¨å–® -->
  <div class="reviewForm" id="reviewForm">
    <div class="starsPick" id="starsPick"></div>

    <textarea
      id="reviewText"
      placeholder="å¯«ä¸‹ä½ çš„ä½¿ç”¨å¿ƒå¾—ï¼ˆéœ€å®Œæˆè³¼è²·ï¼‰..."
    ></textarea>

    <div class="submitRow">
      <span id="reviewHint" style="font-size:12px;color:#777;">
        éœ€å®Œæˆè³¼è²·å¾Œæ‰èƒ½è©•è«–
      </span>
      <button id="submitReviewBtn">é€å‡ºè©•è«–</button>
    </div>
  </div>

  <!-- è©•è«–åˆ—è¡¨ -->
  <div class="reviewsList" id="reviewsList"></div>
</section>


    <!-- å…¶ä»–äººä¹Ÿè²·äº† -->
    <div class="alsoTitle">
      <div class="line"></div>
      <div>å…¶ä»–äººä¹Ÿè²·äº†</div>
      <div class="line"></div>
    </div>

    <section class="cards" id="alsoArea"></section>
  </div>

  <script src="./products-data.js"></script>
  <script>
    // =========================
    // è¨­å®šï¼šå…¨ç«™çµ±ä¸€çš„ key
    // =========================
    const CART_KEY = "meow5_cart";
    const REVIEWS_KEY = "MEOW5_REVIEWS";              // è©•è«–è³‡æ–™

    // å– URL åƒæ•¸ ?id=...
    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    const product = (window.PRODUCTS || []).find(p => p.id === id);

    if(!product){
      alert("æ‰¾ä¸åˆ°æ­¤å•†å“");
      location.href = "products.html";
    }

    // =========================
    // å°å·¥å…·
    // =========================
    function money(n){ return "$" + Number(n || 0).toLocaleString("zh-Hant"); }

    function getImgSrc(fileName){
      if(!fileName) return "https://placehold.co/800x800?text=Meow5";
      if(String(fileName).startsWith("http")) return fileName;

      // ä½ ç›®å‰åœ–ç‰‡æ”¾åœ¨ image/
      // åŒæ™‚ç›¸å®¹ï¼šå¦‚æœä½ ä¹‹å¾ŒçœŸçš„æœ‰ images/ ä¹Ÿ OK
      return `image/${fileName}`;
    }

    function generateStarsHTML(rating){
      const full = Math.round(Number(rating || 0));
      let html = "";
      for(let i=0;i<5;i++){
        const on = i < full;
        html += `
          <span class="star" aria-hidden="true" style="color:${on ? "var(--star)" : "rgba(0,0,0,.12)"}">
            <svg viewBox="0 0 24 24">
              <path d="M12 17.27 18.18 21 16.54 13.97 22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
            </svg>
          </span>
        `;
      }
      return html;
    }

    function readJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        const data = JSON.parse(raw);
        return data ?? fallback;
      }catch{
        return fallback;
      }
    }

    function writeJSON(key, data){
      localStorage.setItem(key, JSON.stringify(data));
    }


    // =========================
    // 1) å¡å•†å“åŸºæœ¬è³‡è¨Š
    // =========================
    document.getElementById("prodName").textContent = product.name;
    document.getElementById("prodPrice").textContent = money(product.price);

    const metaArea = document.getElementById("metaArea");
    metaArea.innerHTML = `
      <span>${product.boughtCount ?? 0} äººå·²è³¼è²·æ­¤ç”¢å“</span>
      <span class="divider"></span>
      <span class="rating">
        <span class="stars" aria-label="æ˜Ÿç­‰">${generateStarsHTML(product.rating)}</span>
        <span>ï¼ˆ${product.reviewCount ?? 0}ï¼‰</span>
      </span>
    `;

    document.getElementById("descBlock").textContent = product.description || "æš«ç„¡ä»‹ç´¹";
    document.getElementById("specBlock").textContent = product.specs || "æš«ç„¡è¦æ ¼";
    document.getElementById("howBlock").textContent = product.howToUse || "æš«ç„¡èªªæ˜";

    // =========================
    // 2) åœ–ç‰‡è¼ªæ’­ï¼ˆå¾ image/ è®€ï¼‰
    // =========================
    const mainImg = document.getElementById("mainImg");
    const dotsArea = document.getElementById("dotsArea");

    let currentIndex = 0;
    function showImage(idx){
      const imgName = (product.images || [])[idx];
      mainImg.src = getImgSrc(imgName);
      mainImg.alt = product.name + " åœ–ç‰‡ " + (idx+1);

      dotsArea.querySelectorAll(".dot").forEach((d,i) => {
        d.classList.toggle("active", i === idx);
      });
    }

    dotsArea.innerHTML = "";
    (product.images || []).forEach((img, i) => {
      const d = document.createElement("div");
      d.className = "dot" + (i===0 ? " active" : "");
      d.addEventListener("click", () => {
        currentIndex = i;
        showImage(i);
      });
      dotsArea.appendChild(d);
    });

    if((product.images || []).length === 0){
      // ç„¡åœ–æ™‚ä¹Ÿè¦é¡¯ç¤ºä¸€å¼µ placeholder
      mainImg.src = "https://placehold.co/800x800?text=Meow5";
      dotsArea.innerHTML = "";
    }else{
      showImage(0);
    }

    // =========================
    // 3) è¦æ ¼ï¼ˆå°ºå¯¸/é¡è‰²ï¼‰
    // =========================
    const tabsArea = document.getElementById("tabsArea");
    const optionsArea = document.getElementById("optionsArea");
    const specLabel = document.getElementById("specLabel");

    function clearChildren(ele){ while(ele.firstChild) ele.removeChild(ele.firstChild); }

    if(product.variantType === "size"){
      specLabel.textContent = "å°ºå¯¸";
      tabsArea.innerHTML = `<button class="tab active" type="button">å°ºå¯¸</button>`;

      const row = document.createElement("div");
      row.className = "optRow";
      (product.sizes || []).forEach((sz, idx) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "sizeBtn" + (idx===0 ? " active" : "");
        btn.textContent = sz;
        btn.dataset.size = sz;
        btn.addEventListener("click", () => {
          row.querySelectorAll(".sizeBtn").forEach(x=>x.classList.remove("active"));
          btn.classList.add("active");
        });
        row.appendChild(btn);
      });

      const bubble = document.createElement("span");
      bubble.className = "bubbleRight";
      bubble.textContent = "è«‹å…ˆé¸æ“‡å°ºå¯¸å†åŠ å…¥è³¼ç‰©è»Š";
      row.appendChild(bubble);

      clearChildren(optionsArea);
      optionsArea.appendChild(row);
    }
    else if(product.variantType === "color"){
      specLabel.textContent = "é¡è‰²";
      tabsArea.innerHTML = `<button class="tab active" type="button">é¡è‰²</button>`;

      const row = document.createElement("div");
      row.className = "optRow";
      (product.colors || []).forEach((c, idx) => {
        const dot = document.createElement("div");
        dot.className = "colorDot" + (idx===0 ? " active" : "");
        dot.style.background = c.hex;
        dot.title = c.label;
        dot.dataset.color = c.code;
        dot.addEventListener("click", () => {
          row.querySelectorAll(".colorDot").forEach(x=>x.classList.remove("active"));
          dot.classList.add("active");
        });
        row.appendChild(dot);
      });

      const bubble = document.createElement("span");
      bubble.className = "bubbleRight";
      bubble.textContent = "è«‹å…ˆé¸æ“‡é¡è‰²å†åŠ å…¥è³¼ç‰©è»Š";
      row.appendChild(bubble);

      clearChildren(optionsArea);
      optionsArea.appendChild(row);
    }
    else{
      tabsArea.innerHTML = "";
      optionsArea.innerHTML = "";
    }

    // =========================
    // 4) åŠ å…¥è³¼ç‰©è»Šï¼ˆèˆ‡ cart.html åŒæ­¥ï¼‰
    //   è³¼ç‰©è»Š item æ ¼å¼ï¼š{ id, qty, variantType, variant }
    // =========================
    document.getElementById("addToCartBtn").addEventListener("click", () => {
      const cart = readJSON(CART_KEY, []);
      let variantType = product.variantType || "";
      let variant = "";

      if(variantType === "size"){
        const btn = optionsArea.querySelector(".sizeBtn.active");
        if(!btn){ alert("è«‹å…ˆé¸æ“‡å°ºå¯¸"); return; }
        variant = btn.dataset.size || "";
      }

      if(variantType === "color"){
        const dot = optionsArea.querySelector(".colorDot.active");
        if(!dot){ alert("è«‹å…ˆé¸æ“‡é¡è‰²"); return; }
        variant = dot.dataset.color || "";
      }

      const exist = cart.find(i => i.id === product.id && (i.variantType || "") === variantType && (i.variant || "") === variant);
      if(exist){
        exist.qty = Math.max(1, parseInt(exist.qty || 1, 10)) + 1;
      }else{
        cart.push({
          id: product.id,
          qty: 1,
          variantType,
          variant
        });
      }

      writeJSON(CART_KEY, cart);
      alert("å·²åŠ å…¥è³¼ç‰©è»Š ğŸ›’");
    });

    const FAV_KEY = "MEOW5_FAVORITES";

function readFavIds(){
  try{
    const v = JSON.parse(localStorage.getItem(FAV_KEY));
    return Array.isArray(v) ? v : [];
  }catch{
    return [];
  }
}
function writeFavIds(ids){
  localStorage.setItem(FAV_KEY, JSON.stringify(ids));
}
function isFav(pid){
  return readFavIds().includes(pid);
}
function updateFavBtn(){
  const pawBtn = document.getElementById("pawBtn");
  if(!pawBtn) return;
  pawBtn.textContent = isFav(product.id) ? "â¤ï¸" : "ğŸ¾"; 
  pawBtn.title = isFav(product.id) ? "å·²æ”¶è—" : "åŠ å…¥æ”¶è—";
}

document.getElementById("pawBtn").addEventListener("click", () => {
  const ids = readFavIds();
  const idx = ids.indexOf(product.id);

  if(idx >= 0){
    ids.splice(idx, 1);
    writeFavIds(ids);
    alert("å·²å¾æ”¶è—ç§»é™¤");
  }else{
    ids.push(product.id);
    writeFavIds(ids);
    alert("å·²åŠ å…¥æ”¶è—æ¸…å–®â¤ï¸");
  }
  updateFavBtn();
});

// å•†å“é è¼‰å…¥å®Œå°±å…ˆæ›´æ–°ä¸€æ¬¡æŒ‰éˆ•ç‹€æ…‹
updateFavBtn();


    // =========================
    // 5) è©•è«–ï¼šè²·éæ‰å¯è©•è«– + æ˜Ÿç­‰ + æ–‡å­—
    // =========================
    const reviewScoreArea = document.getElementById("reviewScoreArea");
    const reviewForm = document.getElementById("reviewForm");
    const reviewHint = document.getElementById("reviewHint");
    const reviewsList = document.getElementById("reviewsList");
    const starsPick = document.getElementById("starsPick");
    const reviewText = document.getElementById("reviewText");
    const submitReviewBtn = document.getElementById("submitReviewBtn");

    // é¡¯ç¤ºå•†å“åŸæœ¬å¹³å‡æ˜Ÿç­‰ï¼ˆè³‡æ–™è¡¨ï¼‰
    reviewScoreArea.innerHTML = `
      <span class="stars">${generateStarsHTML(product.rating)}</span>
      <span>${Number(product.rating || 0).toFixed(1)}</span>
    `;

    // æ˜Ÿç­‰é¸æ“‡å™¨
    let picked = 5;
    function renderStarPicker(){
      starsPick.innerHTML = "";
      for(let i=1;i<=5;i++){
        const s = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        s.setAttribute("viewBox", "0 0 24 24");
        s.classList.add("pickStar");
        if(i <= picked) s.classList.add("on");
        s.innerHTML = `<path d="M12 17.27 18.18 21 16.54 13.97 22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>`;
        s.addEventListener("click", () => {
          picked = i;
          renderStarPicker();
        });
        starsPick.appendChild(s);
      }
    }
    renderStarPicker();

    function getReviews(){
      const all = readJSON(REVIEWS_KEY, []);
      return all.filter(r => r.productId === product.id)
                .sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
    }

    function renderReviews(){
      const list = getReviews();
      reviewsList.innerHTML = "";

      if(list.length === 0){
        reviewsList.innerHTML = `<div class="hintText">ç›®å‰é‚„æ²’æœ‰è©•è«–ï¼Œä¾†ç•¶ç¬¬ä¸€å€‹åˆ†äº«çš„äººå§ ğŸ¾</div>`;
        return;
      }

      list.forEach(r => {
        const div = document.createElement("div");
        div.className = "reviewItem";
        div.innerHTML = `
          <div class="reviewTop">
            <div>
              <span class="reviewUser">${r.user || "æ‚¨"}</span>
              <span style="margin-left:10px" class="stars">${generateStarsHTML(r.stars || 0)}</span>
            </div>
            <div class="reviewTime">${new Date(r.createdAt || Date.now()).toLocaleString("zh-Hant")}</div>
          </div>
          <div class="reviewText">${(r.text || "").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
        `;
        reviewsList.appendChild(div);
      });
    }

    function updateReviewPermission(){
  // âœ… æ”¹æˆï¼šä»»ä½•äººéƒ½å¯ä»¥è©•è«–
  reviewForm.classList.remove("disabled");
  reviewHint.textContent = "å¿«ä¾†ç•™ä¸‹ä½ çš„æƒ³æ³•!!";
  reviewText.placeholder = "é€™è£¡é‚„æ˜¯å…‰ç¦¿ç¦¿çš„è‰åœ°";
}


    submitReviewBtn.addEventListener("click", () => {
      const text = (reviewText.value || "").trim();
      if(!text){
        alert("è©•è«–å…§å®¹ä¸èƒ½ç‚ºç©º");
        return;
      }

      const all = readJSON(REVIEWS_KEY, []);
      all.push({
        productId: product.id,
        user: "å°æ˜",
        stars: picked,
        text,
        createdAt: Date.now()
      });
      writeJSON(REVIEWS_KEY, all);

      reviewText.value = "";
      picked = 5;
      renderStarPicker();
      renderReviews();
      alert("è©•è«–å·²é€å‡º âœ…");
    });

    updateReviewPermission();
    renderReviews();

    // =========================
    // 6) å…¶ä»–äººä¹Ÿè²·äº†ï¼šå¯é»å•†å“å¡
    // =========================
    const alsoArea = document.getElementById("alsoArea");

    function pickAlsoProducts(){
      const all = (window.PRODUCTS || []).filter(p => p.id !== product.id);

      // å„ªå…ˆåŒé¡åˆ¥ theme
      const sameTheme = all.filter(p => p.theme === product.theme);
      const pool = (sameTheme.length >= 4) ? sameTheme : all;

      // ç°¡å–®æ´—ç‰Œå– 4
      const arr = pool.slice();
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr.slice(0,4);
    }

    function renderAlso(){
      const items = pickAlsoProducts();
      alsoArea.innerHTML = "";

      items.forEach(p => {
        const a = document.createElement("a");
        a.className = "p-card";
        a.href = `product-detail.html?id=${encodeURIComponent(p.id)}`;

        const imgName = (p.images || [])[0];
        const imgSrc = getImgSrc(imgName);

        a.innerHTML = `
          <div class="p-img" style="background-image:url('${imgSrc}')"></div>
          <div class="p-body">
            <div class="p-name">${p.name}</div>
            <div class="p-price">${money(p.price)}</div>
          </div>
        `;
        alsoArea.appendChild(a);
      });
    }

    renderAlso();

    
  </script>
</body>
</html>
