<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>結帳｜Meow5</title>
  <link rel="stylesheet" href="./checkout.css" />
</head>

<body>
  <main class="wrap">
    <section class="block">
      <h2 class="block-title">購物車商品</h2>

      <div class="cart-lines" id="cartLines">
        <div class="empty">尚未載入購物車商品</div>
      </div>
    </section>

    <section class="block">
      <h2 class="block-title">取貨方式</h2>

      <div class="choice-row" role="radiogroup" aria-label="取貨方式">
        <label class="choice">
          <input type="radio" name="ship" value="home" checked />
          <span>宅配到府</span>
        </label>
      </div>

      <div class="address-box" id="addressBox" style="margin-top:14px;">
        <label style="display:block; font-weight:800; margin-bottom:8px;">收件地址</label>
        <input
          id="addressInput"
          type="text"
          placeholder="請輸入：縣市 / 區 / 路街 / 號 / 樓"
          style="
            width:100%;
            padding:12px 14px;
            border-radius:12px;
            border:1px solid rgba(0,0,0,.15);
            outline:none;
          "
        />
        <p class="hint" id="shipHint" aria-live="polite" style="margin-top:8px;">
          未滿 $2000 運費 $150，滿 $2000 免運。
        </p>
      </div>
    </section>

    <section class="block">
      <h2 class="block-title">付款方式</h2>

      <div class="choice-row" role="radiogroup" aria-label="付款方式">
        <label class="choice">
          <input type="radio" name="pay" value="cod" checked />
          <span>貨到付款</span>
        </label>

        <label class="choice">
          <input type="radio" name="pay" value="card" />
          <span>信用卡</span>
        </label>

        <label class="choice">
          <input type="radio" name="pay" value="atm" />
          <span>簽帳卡</span>
        </label>
      </div>
    </section>

    <div class="divider"></div>

    <section class="block">
      <div class="price-box">
        <div class="price-row">
          <div class="label">商品金額</div>
          <div class="value" id="subtotalText">$ 0</div>
        </div>

        <div class="price-row">
          <div class="label">運費</div>
          <div class="value" id="shippingText">$ 0</div>
        </div>

        <div class="thin-line"></div>

        <div class="price-row total">
          <div class="label">總付款金額</div>
          <div class="value" id="grandText">$ 0</div>
        </div>
      </div>

      <div class="buy-row">
        <button class="buy-btn" id="buyBtn" type="button">購買</button>
      </div>
    </section>
  </main>

  <script src="./products-data.js"></script>

  <script>
    // ====== Keys（全站統一）======
    const CART_KEY = "meow5_cart";
    const CHECKOUT_KEY = "MEOW5_CHECKOUT_ITEMS";
    const ORDERS_KEY = "MEOW5_ORDERS";     // ✅ 存所有訂單
    const LAST_ORDER_KEY = "MEOW5_LAST_ORDER_ID";

    // ====== 運費規則 ======
    const FREE_SHIPPING_THRESHOLD = 2000;
    const HOME_SHIPPING_FEE = 150;

    const cartLinesEl = document.getElementById("cartLines");
    const subtotalTextEl = document.getElementById("subtotalText");
    const shippingTextEl = document.getElementById("shippingText");
    const grandTextEl = document.getElementById("grandText");
    const buyBtn = document.getElementById("buyBtn");
    const addressInput = document.getElementById("addressInput");

    function resolveImg(src){
      if(!src) return "image/no-image.png";
      if(String(src).startsWith("http")) return src;
      if(String(src).startsWith("image/")) return src;
      return "image/" + src;
    }

    function money(n) {
      return "$ " + Number(n).toLocaleString("zh-Hant");
    }

    function readJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        const v = JSON.parse(raw);
        return (v ?? fallback);
      }catch{
        return fallback;
      }
    }

    function writeJSON(key, data){
      localStorage.setItem(key, JSON.stringify(data));
    }

    // ✅ 統一成 {id, qty}
    function normalizeCart(items){
      const arr = [];
      (items || []).forEach(it => {
        if(!it || !it.id) return;
        const qty = Math.max(1, parseInt(it.qty ?? 1, 10));
        arr.push({ id: it.id, qty });
      });
      return arr;
    }

    function getProductById(id) {
      return (window.PRODUCTS || []).find(p => p.id === id);
    }

    function getProductImage(p) {
      const first = p?.images?.[0];
      if (!first) return "https://placehold.co/100x100?text=Meow5";
      return resolveImg(first);
    }

    function loadCheckoutItems() {
      // 先讀 checkout key；沒有就 fallback cart（避免忘了同步也能用）
      const a = normalizeCart(readJSON(CHECKOUT_KEY, []));
      if (a.length) return a;

      const b = normalizeCart(readJSON(CART_KEY, []));
      return b;
    }

    function calcTotals(items) {
      let subtotal = 0;

      for (const it of items) {
        const p = getProductById(it.id);
        const price = Number(p?.price ?? 0);
        subtotal += price * it.qty;
      }

      const shipping = (subtotal === 0 || subtotal >= FREE_SHIPPING_THRESHOLD) ? 0 : HOME_SHIPPING_FEE;
      const grand = subtotal + shipping;

      return { subtotal, shipping, grand };
    }

    function renderLines(items) {
      if (!items.length) {
        cartLinesEl.innerHTML = `
          <div class="empty">
            目前沒有要結帳的商品（請從購物車頁面點「前往結帳」進來）
          </div>
        `;
        buyBtn.disabled = true;
        buyBtn.style.opacity = "0.5";
        return;
      }

      buyBtn.disabled = false;
      buyBtn.style.opacity = "1";
      cartLinesEl.innerHTML = "";

      items.forEach((it) => {
        const p = getProductById(it.id);
        const name = p ? p.name : it.id;
        const price = Number(p?.price ?? 0);
        const img = p ? getProductImage(p) : "https://placehold.co/100x100?text=Meow5";
        const lineTotal = price * it.qty;

        const row = document.createElement("div");
        row.className = "cart-line";
        row.style.cssText = `
          display:flex; align-items:center; gap:14px;
          padding:14px 6px; border-bottom:1px solid rgba(0,0,0,.08);
        `;

        row.innerHTML = `
          <div style="
            width:56px; height:56px; border-radius:12px;
            background:#f3f3f3 url('${img}') center/cover no-repeat;
            flex:0 0 auto;
          "></div>

          <div style="flex:1; min-width:0; text-align:left;">
            <div style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
              ${name}
            </div>
            <div style="font-size:.9rem; color:#b0714d; font-weight:900; margin-top:6px;">
              ${money(price)} × ${it.qty}
            </div>
          </div>

          <div style="font-weight:900; white-space:nowrap;">
            ${money(lineTotal)}
          </div>
        `;

        cartLinesEl.appendChild(row);
      });
    }

    function renderTotals(items) {
      const { subtotal, shipping, grand } = calcTotals(items);

      subtotalTextEl.textContent = money(subtotal);
      shippingTextEl.textContent = shipping === 0 ? "免運" : money(shipping);
      grandTextEl.textContent = money(grand);
    }

    function renderAll() {
      const items = loadCheckoutItems();

      // ✅ 順手把舊格式洗乾淨（避免下次又跑出 variant 欄位）
      writeJSON(CHECKOUT_KEY, items);

      renderLines(items);
      renderTotals(items);
    }

    function makeOrderId(){
      // EX: MEO20260104-123456
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      const rnd = String(Math.floor(Math.random()*900000)+100000);
      return `MEO${y}${m}${day}-${rnd}`;
    }

    // ===== 購買：檢查地址 → 建立訂單 → 清空購物車 → 進 order.html =====
    buyBtn.addEventListener("click", () => {
      const items = loadCheckoutItems();
      if (!items.length) return;

      const addr = (addressInput.value || "").trim();
      if (!addr) {
        alert("請先填寫收件地址喵～");
        addressInput.focus();
        return;
      }

      const shipMethod = "宅配到府";
      const payMethod = document.querySelector('input[name="pay"]:checked')?.value || "cod";

      const { subtotal, shipping, grand } = calcTotals(items);

      // 把商品行整理成訂單明細
      const lines = items.map(it => {
        const p = getProductById(it.id);
        return {
          id: it.id,
          name: p?.name || it.id,
          price: Number(p?.price ?? 0),
          qty: it.qty,
          image: p?.images?.[0] || "",
          lineTotal: Number(p?.price ?? 0) * it.qty
        };
      });

      const order = {
        orderId: makeOrderId(),
        createdAt: Date.now(),
        address: addr,
        shippingMethod: shipMethod,
        paymentMethod: payMethod,  // cod/card/atm
        subtotal,
        shippingFee: shipping,
        grandTotal: grand,
        items: lines
      };

      const allOrders = readJSON(ORDERS_KEY, []);
      allOrders.unshift(order);
      writeJSON(ORDERS_KEY, allOrders);
      localStorage.setItem(LAST_ORDER_KEY, order.orderId);

      // ✅ 清空購物車與結帳暫存
      localStorage.removeItem(CART_KEY);
      localStorage.removeItem(CHECKOUT_KEY);

      
      location.href = "./checkout-success.html";
    });

    // 初次載入
    renderAll();
  </script>
</body>
</html>


