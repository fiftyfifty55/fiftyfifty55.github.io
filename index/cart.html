<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è³¼ç‰©è»Š - Meow5</title>

  <style>
    :root {
      --c-parchment: #edede9;
      --c-bone: #d6ccc2;
      --c-linen: #f5ebe0;
      --c-almond-cream: #e3d5ca;
      --c-almond-silk: #d5bdaf;
      --text-dark: #3d3d3d;
      --c-success: #84a59d;
      --accent: #b0714d;
    }

    body {
      font-family: system-ui, "Noto Sans TC", sans-serif;
      background-color: var(--c-parchment);
      margin: 0;
      color: var(--text-dark);
    }

    .page-content {
      padding: 80px 20px;
      text-align: center;
    }

    .back-link {
      display: inline-block;
      margin-top: 20px;
      color: var(--accent);
      text-decoration: none;
      font-weight: bold;
      border: 1px solid var(--accent);
      padding: 8px 20px;
      border-radius: 20px;
      transition: all 0.3s;
    }
    .back-link:hover {
      background: var(--accent);
      color: white;
    }

    /* æµ®å‹•è³¼ç‰©è»ŠæŒ‰éˆ• */
    .cart-trigger {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 70px;
      height: 70px;
      background: var(--c-almond-silk);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(213, 189, 175, 0.5);
      z-index: 100;
      transition: transform 0.3s ease;
      user-select: none;
    }
    .cart-trigger:hover { transform: scale(1.1); }
    .cart-trigger span { font-size: 30px; }

    /* èƒŒæ™¯é®ç½© */
    .cart-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      z-index: 999;
      backdrop-filter: blur(3px);
    }

    /* è³¼ç‰©è»Šå´é‚Šæ¬„ */
    .cart-overlay {
      position: fixed;
      top: 0;
      right: -450px;
      width: 100%;
      max-width: 400px;
      height: 100%;
      background: #fff;
      box-shadow: -10px 0 30px rgba(0, 0, 0, 0.05);
      z-index: 1000;
      transition: right 0.5s cubic-bezier(0.16, 1, 0.3, 1);
      display: flex;
      flex-direction: column;
    }
    .cart-overlay.active { right: 0; }

    .cart-header {
      padding: 26px 22px;
      background: var(--c-linen);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .cart-header h3 {
      margin: 0;
      letter-spacing: 2px;
      font-weight: 900;
    }
    .close-cart {
      cursor: pointer;
      font-size: 24px;
      color: var(--c-almond-silk);
      user-select: none;
    }

    /* å…é‹é€²åº¦æ¢ */
    .shipping-promo {
      padding: 16px 22px;
      background: #fff;
      border-bottom: 1px solid var(--c-parchment);
    }
    .shipping-text {
      font-size: 0.85rem;
      margin-bottom: 10px;
      color: #666;
    }
    .progress-bar {
      height: 8px;
      background: var(--c-parchment);
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      width: 0%;
      height: 100%;
      background: var(--c-almond-silk);
      transition: width 0.5s ease;
    }

    /* å•†å“åˆ—è¡¨ */
    .cart-items {
      flex-grow: 1;
      padding: 18px 22px;
      overflow-y: auto;
    }
    .item {
      display: flex;
      margin-bottom: 18px;
      align-items: center;
      gap: 12px;
    }
    .item-img {
      width: 70px;
      height: 70px;
      border-radius: 12px;
      background-size: cover;
      background-position: center;
      background-color: #f8f8f8;
      border: 1px solid var(--c-parchment);
      flex: 0 0 auto;
    }
    .item-info { flex-grow: 1; min-width: 0; }
    .item-name {
      font-weight: 800;
      font-size: 0.95rem;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .item-price {
      color: var(--accent);
      font-weight: 900;
      font-size: 0.9rem;
    }

    .item-qty-control {
      display: flex;
      align-items: center;
      margin-top: 8px;
      gap: 10px;
    }
    .qty-btn {
      width: 28px;
      height: 28px;
      border: 1px solid var(--c-bone);
      background: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 900;
      line-height: 1;
    }
    .qty-num{
      min-width: 18px;
      text-align: center;
      font-weight: 900;
      color: #444;
    }

    .remove-btn{
      border:none;
      background: transparent;
      color: #999;
      cursor: pointer;
      font-size: 14px;
      padding: 6px;
      user-select:none;
    }
    .remove-btn:hover{ color:#333; }

    /* åº•éƒ¨çµç®—å€ */
    .cart-footer {
      padding: 22px;
      background: var(--c-parchment);
      border-radius: 24px 24px 0 0;
    }
    .summary-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #666;
    }
    .total-row {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--c-bone);
      font-size: 1.2rem;
      font-weight: 900;
      color: var(--accent);
    }

    .checkout-btn {
      width: 100%;
      padding: 16px;
      background: var(--c-almond-silk);
      color: white;
      border: none;
      border-radius: 14px;
      font-size: 1.05rem;
      font-weight: 900;
      cursor: pointer;
      margin-top: 14px;
      transition: all 0.25s;
    }
    .checkout-btn:hover {
      background: var(--text-dark);
      transform: translateY(-2px);
    }
    .checkout-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .empty-msg {
      text-align: center;
      color: #999;
      margin-top: 40px;
      line-height: 1.7;
    }
  </style>
</head>

<body>
  <div class="page-content">
    <h1>Meow5 è²“ç‰©å•†åº—</h1>
    <p>é»æ“Šå³ä¸‹è§’è‚‰çƒæŸ¥çœ‹è³¼ç‰©è»Š ğŸ¾</p>
    <a href="index.html" class="back-link">â† å›é¦–é é€›é€›</a>
  </div>

  <div class="cart-trigger" id="openCart" aria-label="é–‹å•Ÿè³¼ç‰©è»Š">
    <span>ğŸ¾</span>
  </div>

  <div class="cart-backdrop" id="backdrop"></div>

  <div class="cart-overlay" id="cart" aria-hidden="true">
    <div class="cart-header">
      <h3>è³¼ç‰©è»Šæ¸…å–®</h3>
      <span class="close-cart" id="closeCart" aria-label="é—œé–‰è³¼ç‰©è»Š">âœ•</span>
    </div>

    <div class="shipping-promo">
      <div class="shipping-text" id="shippingText">è¨ˆç®—ä¸­...</div>
      <div class="progress-bar">
        <div class="progress-fill" id="shippingProgress"></div>
      </div>
    </div>

    <div class="cart-items" id="cartItemsList"></div>

    <div class="cart-footer">
      <div class="summary-line">
        <span>å°è¨ˆ Subtotal</span>
        <span id="subtotalPrice">$0</span>
      </div>
      <div class="summary-line">
        <span>é‹è²» Shipping</span>
        <span id="shippingFee">$0</span>
      </div>
      <div class="total-row">
        <span>ç¸½è¨ˆ Total</span>
        <span id="finalTotal">$0</span>
      </div>
      <button class="checkout-btn" id="goToCheckout">å‰å¾€çµå¸³</button>
    </div>
  </div>

  <script src="./products-data.js"></script>

  <script>
    // ======= è¨­å®šï¼ˆè·Ÿå•†å“è©³æƒ…é ä¸€è‡´ï¼‰ =======
    const CART_KEY = "meow5_cart";
    const CHECKOUT_KEY = "MEOW5_CHECKOUT_ITEMS";

    const FREE_SHIPPING_THRESHOLD = 2000; // æ»¿ 2000 å…é‹
    const DEFAULT_SHIPPING_FEE = 150;

    // ======= DOM =======
    const cartOverlay = document.getElementById("cart");
    const openBtn = document.getElementById("openCart");
    const closeBtn = document.getElementById("closeCart");
    const backdrop = document.getElementById("backdrop");
    const listContainer = document.getElementById("cartItemsList");
    const checkoutBtn = document.getElementById("goToCheckout");

    // ======= Open / Close =======
    function toggleCart(isOpen) {
      if (isOpen) {
        render();
        cartOverlay.classList.add("active");
        cartOverlay.setAttribute("aria-hidden", "false");
        backdrop.style.display = "block";
        document.body.style.overflow = "hidden";
      } else {
        cartOverlay.classList.remove("active");
        cartOverlay.setAttribute("aria-hidden", "true");
        backdrop.style.display = "none";
        document.body.style.overflow = "";
      }
    }
    openBtn.addEventListener("click", () => toggleCart(true));
    closeBtn.addEventListener("click", () => toggleCart(false));
    backdrop.addEventListener("click", () => toggleCart(false));
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") toggleCart(false);
    });

    // ======= åœ–ç‰‡è·¯å¾‘çµ±ä¸€ï¼ˆæ”¯æ´ image/ / http / æª”åï¼‰ =======
    function resolveImg(src){
      if(!src) return "image/no-image.png";
      if(String(src).startsWith("http")) return src;
      if(String(src).startsWith("image/")) return src;
      return "image/" + src;
    }

    // ======= Storage helpers =======
    function loadCart() {
      try {
        const raw = JSON.parse(localStorage.getItem(CART_KEY));
        return Array.isArray(raw) ? raw : [];
      } catch {
        return [];
      }
    }
    function saveCart(items) {
      localStorage.setItem(CART_KEY, JSON.stringify(items));
    }

    // âœ… å…¼å®¹èˆŠè³‡æ–™ï¼šè‡ªå‹•è½‰æˆ {id, qty}
    function normalizeCart(items){
      const arr = [];
      (items || []).forEach(it => {
        if(!it || !it.id) return;
        const qty = Math.max(1, parseInt(it.qty ?? 1, 10));
        arr.push({ id: it.id, qty });
      });
      return arr;
    }

    function money(n) {
      return "$" + Number(n).toLocaleString("zh-Hant");
    }

    function getProductById(pid) {
      return (window.PRODUCTS || []).find(p => p.id === pid);
    }

    function getProductImage(p) {
      const first = p?.images?.[0];
      if (!first) return "https://placehold.co/100x100?text=Meow5";
      return resolveImg(first);
    }

    // ======= Render =======
    function render() {
      const raw = normalizeCart(loadCart());

      // âœ… å¦‚æœæœ‰èˆŠæ ¼å¼ï¼Œé †æ‰‹è¦†è“‹ä¸€æ¬¡ï¼ˆæ¸…æ‰ variant æ¬„ä½ï¼‰
      saveCart(raw);

      listContainer.innerHTML = "";

      if (raw.length === 0) {
        listContainer.innerHTML = `<div class="empty-msg">è³¼ç‰©è»Šç©ºç©ºå¦‚ä¹Ÿå–µ... ğŸ¾<br>å¿«å»æŒ‘é¸å–œæ­¡çš„å•†å“å§ï¼</div>`;
        checkoutBtn.disabled = true;
        updateAccounting(0);
        return;
      }

      checkoutBtn.disabled = false;

      let subtotal = 0;

      raw.forEach((it, index) => {
        const p = getProductById(it.id);
        const price = Number(p?.price ?? 0);
        const lineTotal = price * it.qty;
        subtotal += lineTotal;

        const imgSrc = p ? getProductImage(p) : "https://placehold.co/100x100?text=Meow5";

        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="item-img" style="background-image:url('${imgSrc}')"></div>

          <div class="item-info">
            <div class="item-name">${p ? p.name : it.id}</div>
            <div class="item-price">${money(price)}</div>

            <div class="item-qty-control">
              <button class="qty-btn" data-act="dec" data-i="${index}" aria-label="æ¸›å°‘">-</button>
              <span class="qty-num">${it.qty}</span>
              <button class="qty-btn" data-act="inc" data-i="${index}" aria-label="å¢åŠ ">+</button>
              <button class="remove-btn" data-act="rm" data-i="${index}">åˆªé™¤</button>
            </div>
          </div>

          <div style="font-weight:900;color:#555;white-space:nowrap;">
            ${money(lineTotal)}
          </div>
        `;
        listContainer.appendChild(div);
      });

      updateAccounting(subtotal);
    }

    function updateAccounting(subtotal) {
      const subtotalEl = document.getElementById("subtotalPrice");
      const shippingEl = document.getElementById("shippingFee");
      const finalTotalEl = document.getElementById("finalTotal");
      const progressFill = document.getElementById("shippingProgress");
      const shippingText = document.getElementById("shippingText");

      const isFree = subtotal >= FREE_SHIPPING_THRESHOLD;
      const shippingFee = (subtotal === 0 || isFree) ? 0 : DEFAULT_SHIPPING_FEE;

      subtotalEl.textContent = money(subtotal);
      shippingEl.textContent = isFree ? "å…é‹âœ¨" : money(shippingFee);
      finalTotalEl.textContent = money(subtotal + shippingFee);

      const progress = Math.min((subtotal / FREE_SHIPPING_THRESHOLD) * 100, 100);
      progressFill.style.width = progress + "%";
      progressFill.style.backgroundColor = isFree ? "var(--c-success)" : "var(--c-almond-silk)";

      if (subtotal === 0) {
        shippingText.textContent = "è³¼ç‰©è»Šå°šç„¡å•†å“";
      } else if (isFree) {
        shippingText.innerHTML = "âœ¨ <b>æ­å–œï¼</b>å·²é”æˆå…é‹å„ªæƒ  ğŸšš";
      } else {
        const diff = FREE_SHIPPING_THRESHOLD - subtotal;
        shippingText.innerHTML = `é‚„å·® <b>${money(diff)}</b> å³å¯äº«æœ‰å…é‹å„ªæƒ  ğŸšš`;
      }
    }

    // ======= Event delegationï¼š+ / - / åˆªé™¤ =======
    listContainer.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-act]");
      if (!btn) return;

      const act = btn.dataset.act;
      const i = parseInt(btn.dataset.i, 10);

      const items = normalizeCart(loadCart());
      if (!items[i]) return;

      if (act === "inc") {
        items[i].qty += 1;
      } else if (act === "dec") {
        items[i].qty -= 1;
        if (items[i].qty <= 0) {
          if (confirm("è¦å¾è³¼ç‰©è»Šç§»é™¤é€™é …å•†å“å—ï¼Ÿ")) {
            items.splice(i, 1);
          } else {
            items[i].qty = 1;
          }
        }
      } else if (act === "rm") {
        if (confirm("ç¢ºå®šè¦åˆªé™¤é€™é …å•†å“å—ï¼Ÿ")) {
          items.splice(i, 1);
        } else {
          return;
        }
      }

      saveCart(items);
      render();
    });

    // ======= çµå¸³è·³è½‰ =======
    checkoutBtn.addEventListener("click", () => {
      const items = normalizeCart(loadCart());

      if (!items.length) {
        alert("è³¼ç‰©è»Šæ²’æœ‰å•†å“å–µï½");
        return;
      }

      localStorage.setItem(CHECKOUT_KEY, JSON.stringify(items));
      location.href = "./checkout.html";
    });

    // ç¬¬ä¸€æ¬¡è¼‰å…¥å…ˆç®—ä¸€æ¬¡
    render();
  </script>
</body>
</html>
